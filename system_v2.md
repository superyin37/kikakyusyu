# Kita System Architecture v2.0 (Hybrid Grounding)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ‘¤ User (Browser)                            â”‚
â”‚         ã€Œãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ã‚’æ¨ã¦ãŸã„ã®ã§ã™ãŒã€                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ–¥ Frontend : Streamlit (front-app)                   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ Chat UI (Blocking / Streaming)                              â”‚
â”‚ â€¢ GPU / VRAM Monitor (NVML / nvidia-smi)                      â”‚
â”‚ â€¢ Knowledge File Upload (PDF / TXT / CSV)                     â”‚
â”‚ â€¢ Chat History & Log Viewer                                   â”‚
â”‚ â€¢ NEW: Grounding Confidence Display                           â”‚
â”‚                                                               â”‚
â”‚ â†’ POST /api/bot/respond                                       â”‚
â”‚ â†’ POST /api/bot/respond_stream                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              HTTP (JSON / Streaming Text)
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       âš™ Backend API : FastAPI (backend-app)                  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ API Routing                                                 â”‚
â”‚   - /respond        (Blocking)                                â”‚
â”‚   - /respond_stream (Streaming)                               â”‚
â”‚                                                               â”‚
â”‚ â€¢ RAG Orchestration (v2.0)                                    â”‚
â”‚   - rag_retrieve_extended() â† ä½¿ç”¨ Hybrid Grounding          â”‚
â”‚   - ask_ollama()                                              â”‚
â”‚                                                               â”‚
â”‚ â€¢ Enhanced Reference Packaging                                â”‚
â”‚   - grounding_info (confidence, candidates, time)             â”‚
â”‚   - performance metrics                                       â”‚
â”‚   - JSON body / HTTP header                                   â”‚
â”‚                                                               â”‚
â”‚ â€¢ API-side Logging (with Hybrid metrics)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ§  RAG Core & Knowledge Layer v2.0 (rag)                    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                          â”‚
â”‚ â‘  Query Understanding ã€NEW: Hybrid Grounding Systemã€‘                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ ğŸ¯ Hybrid Grounding (hybrid_grounding.py)                     â”‚    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â”‚  STEP 1: Exact Match Check (ç²¾ç¢ºåŒ¹é…å±¤)                        â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚   â”‚  â”‚ å…¥åŠ› == DBå“å ?                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚   YES â†’ ç½®ä¿¡åº¦1.0 å³è¿”å´ (<5ms)               â”‚             â”‚    â”‚
â”‚   â”‚  â”‚   NO  â†’ STEP 2                                â”‚             â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â”‚  STEP 2: Path Selection (æ™ºèƒ½åˆ†æµå±¤)                           â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚   â”‚  â”‚ å…¥åŠ›é•· < 20æ–‡å­— ?                             â”‚             â”‚    â”‚
â”‚   â”‚  â”‚                                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ YES â†’ ğŸ…°ï¸ Path A Only (å¿«é€Ÿè·¯å¾„)              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â”œâ”€ æ•´ä½“Embedding                       â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â”œâ”€ ChromaDBé¡ä¼¼åº¦æ¤œç´¢                   â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â””â”€ Top-3å€™è£œè¿”å´ (<300ms)              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚                                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ NO  â†’ ğŸ…°ï¸ğŸ…±ï¸ Path A + Path B (åŒè·¯å¾„)          â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â”œâ”€ Path A: æ•´ä½“Embeddingæ¤œç´¢           â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â”‚                                      â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â””â”€ Path B: LLMè£œåŠ©æŠ½å‡º                 â”‚             â”‚    â”‚
â”‚   â”‚  â”‚           â”œâ”€ LLMæŠ½å‡ºå€™è£œçŸ­èª                 â”‚             â”‚    â”‚
â”‚   â”‚  â”‚           â”‚   (swallow:latest)               â”‚             â”‚    â”‚
â”‚   â”‚  â”‚           â”œâ”€ å„çŸ­èªEmbeddingæ¤œç´¢             â”‚             â”‚    â”‚
â”‚   â”‚  â”‚           â””â”€ å€™è£œåˆå¹¶ä¸å»é‡                   â”‚             â”‚    â”‚
â”‚   â”‚  â”‚                                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚       â± Total: <600ms                        â”‚             â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â”‚  STEP 3: Confidence Evaluation (ç½®ä¿¡åº¦è©•ä¾¡å±¤)                  â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚   â”‚  â”‚ â€¢ High   : score â‰¥ 0.70                      â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ â€¢ Medium : 0.45 â‰¤ score < 0.70               â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ â€¢ Low    : score < 0.45                      â”‚             â”‚    â”‚
â”‚   â”‚  â”‚                                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ â€¢ Ambiguity: |Top1 - Top2| < 0.05            â”‚             â”‚    â”‚
â”‚   â”‚  â”‚                                              â”‚             â”‚    â”‚
â”‚   â”‚  â”‚ ğŸ›¡ï¸ Fallback: Hybridå¤±æ•— â†’ MeCabé™ç´š          â”‚             â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â”‚  Output:                                                       â”‚    â”‚
â”‚   â”‚    â”œâ”€ primary_candidate: "ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³"                       â”‚    â”‚
â”‚   â”‚    â”œâ”€ confidence_level: "high"                                 â”‚    â”‚
â”‚   â”‚    â”œâ”€ similarity: 1.0                                          â”‚    â”‚
â”‚   â”‚    â”œâ”€ is_ambiguous: false                                      â”‚    â”‚
â”‚   â”‚    â”œâ”€ execution_time_ms: 35.2                                  â”‚    â”‚
â”‚   â”‚    â””â”€ path_used: "path_a_only"                                 â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚   ç”ºåå‡¦ç† (å¤‰æ›´ãªã—)                                                     â”‚
â”‚   â””â”€ éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ â†’ ç”ºåæŠ½å‡º                                              â”‚
â”‚                                                                          â”‚
â”‚ â‘¡ Multi-Source Retrieval                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ ChromaDB (Persistent)                                      â”‚        â”‚
â”‚   â”‚                                                            â”‚        â”‚
â”‚   â”‚ â€¢ gomi collection   : ã”ã¿åˆ†åˆ¥ãƒ«ãƒ¼ãƒ« (865ä»¶)               â”‚        â”‚
â”‚   â”‚   â””â”€ Embedding: kun432/cl-nagoya-ruri-large:337m          â”‚        â”‚
â”‚   â”‚                                                            â”‚        â”‚
â”‚   â”‚ â€¢ area collection   : ç”ºåÃ—åé›†æ—¥                           â”‚        â”‚
â”‚   â”‚                                                            â”‚        â”‚
â”‚   â”‚ â€¢ knowledge         : ãƒ¦ãƒ¼ã‚¶PDFç­‰ãƒŠãƒ¬ãƒƒã‚¸                   â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                          â”‚
â”‚ â‘¢ Context Construction                                                   â”‚
â”‚   - ã€ã”ã¿åˆ†åˆ¥æƒ…å ±ã€‘â† Hybrid Groundingçµæœ                               â”‚
â”‚   - ã€ç”ºåæƒ…å ±ã€‘                                                          â”‚
â”‚   - ã€ãƒ¦ãƒ¼ã‚¶ãƒŠãƒ¬ãƒƒã‚¸æƒ…å ±ã€‘                                                 â”‚
â”‚   - NEW: ã€Groundingå“è³ªæƒ…å ±ã€‘(confidence, candidates)                   â”‚
â”‚                                                                          â”‚
â”‚ â‘£ Prompt Generation                                                      â”‚
â”‚   - system prompt (åˆ¶ç´„ãƒ»å®‰å…¨ãƒ»å“åå³å®ˆãƒ«ãƒ¼ãƒ«)                             â”‚
â”‚   - user prompt + enriched RAG context                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ¤– LLM Inference : Ollama                             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ Local LLM (Llama-3.1-Swallow-8B)                            â”‚
â”‚ â€¢ Blocking / Streaming Generation                             â”‚
â”‚ â€¢ GPU / CPU Execution                                         â”‚
â”‚                                                               â”‚
â”‚ â€¢ NEW: Also used in Path B (å“åæŠ½å‡º)                          â”‚
â”‚   - Temperature: 0.1 (ä½æ¸©åº¦ã§å®‰å®šå‡ºåŠ›)                        â”‚
â”‚   - Timeout: 5ç§’ (ä¿è­·æ©Ÿèƒ½)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ğŸ“¤ Response + Enhanced References                       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ Answer Text                                                 â”‚
â”‚                                                               â”‚
â”‚ â€¢ references (Enhanced v2.0)                                  â”‚
â”‚   â”œâ”€ file / page / chunk (å¾“æ¥é€šã‚Š)                           â”‚
â”‚   â”‚                                                           â”‚
â”‚   â”œâ”€ ã€NEWã€‘grounding_info:                                   â”‚
â”‚   â”‚   â”œâ”€ type: "grounding_info"                               â”‚
â”‚   â”‚   â”œâ”€ confidence: "high|medium|low"                        â”‚
â”‚   â”‚   â”œâ”€ is_ambiguous: bool                                   â”‚
â”‚   â”‚   â”œâ”€ candidates: ["å€™è£œ1", "å€™è£œ2", "å€™è£œ3"]              â”‚
â”‚   â”‚   â””â”€ execution_time_ms: float                             â”‚
â”‚   â”‚                                                           â”‚
â”‚   â””â”€ ã€NEWã€‘performance:                                      â”‚
â”‚       â”œâ”€ type: "performance"                                  â”‚
â”‚       â””â”€ retrieval_time_ms: float (Hybridå«ã‚€)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ–¥ Streamlit UI Rendering                              â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ Chat Output                                                 â”‚
â”‚ â€¢ Streaming Effect                                            â”‚
â”‚ â€¢ Reference Panel                                             â”‚
â”‚ â€¢ GPU Status Update                                           â”‚
â”‚                                                               â”‚
â”‚ â€¢ NEW: Grounding Quality Indicators                           â”‚
â”‚   â”œâ”€ Confidence Badge (High/Medium/Low)                       â”‚
â”‚   â”œâ”€ Alternative Candidates (if ambiguous)                    â”‚
â”‚   â””â”€ Performance Metrics                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†• v2.0 ä¸»è¦å¤‰æ›´ç‚¹

### 1. Hybrid Grounding System (å“åæŒ‡ç§° v2.0)
```
å¾“æ¥ (v1.0)                    æ–°ç‰ˆ (v2.0)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MeCabåè©æŠ½å‡º                â†’ Hybrid 3å±¤ã‚·ã‚¹ãƒ†ãƒ 
  â†“                             â”œâ”€ ç²¾ç¢ºãƒãƒƒãƒãƒ³ã‚° (æœ€å„ªå…ˆ)
å˜ç´”ãƒªã‚¹ãƒˆãƒãƒƒãƒãƒ³ã‚°              â”œâ”€ Path A: æ•´ä½“Embedding
  â†“                             â”œâ”€ Path B: LLMè£œåŠ©
å“åå€™è£œ1ã¤                       â””â”€ ç½®ä¿¡åº¦è©•ä¾¡ + æ›–æ˜§æ€§æ¤œå‡º
                                    â†“
                                 å“åå€™è£œ3ã¤ + å“è³ªæŒ‡æ¨™
```

### 2. æ€§èƒ½æŒ‡æ¨™
| æŒ‡æ¨™ | v1.0 | v2.0 | æ”¹å–„ |
|-----|------|------|------|
| ç²¾ç¢ºãƒãƒƒãƒãƒ³ã‚° | N/A | **2-5ms** | ğŸ†• |
| çŸ­å…¥åŠ› | 50-100ms | **30-40ms** | â¬‡ï¸30% |
| é•·å…¥åŠ› | 100-200ms | **400-600ms** | â¬†ï¸(but ç²¾åº¦â†‘â†‘) |
| å“åç²¾åº¦ | 70-80% | **85-95%** | â¬†ï¸15-20% |

### 3. æ–°æ©Ÿèƒ½
- âœ… **ç²¾ç¢ºãƒãƒƒãƒãƒ³ã‚°å„ªå…ˆ**: å®Œå…¨ä¸€è‡´ â†’ ç½®ä¿¡åº¦1.0å³è¿”å´
- âœ… **æ™ºèƒ½è·¯å¾„åˆ†æµ**: çŸ­å…¥åŠ›å¿«é€Ÿè·¯å¾„ / é•·å…¥åŠ›åŒè·¯å¾„
- âœ… **ç½®ä¿¡åº¦è©•ä¾¡**: High/Medium/Lowä¸‰ç´šè©•ä¾¡
- âœ… **æ›–æ˜§æ€§æ¤œå‡º**: Topå€™è£œãŒè¿‘ã„å ´åˆã«è­¦å‘Š
- âœ… **è‡ªå‹•é™ç´š**: Hybridå¤±æ•—æ™‚MeCabã«è‡ªå‹•åˆ‡æ›¿
- âœ… **è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: å®Ÿè¡Œæ™‚é–“ãƒ»ä½¿ç”¨è·¯å¾„ã®å¯è¦–åŒ–

### 4. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¤‰åŒ–
```
ã€v1.0ã€‘
å…¥åŠ› â†’ MeCab â†’ åè©ãƒªã‚¹ãƒˆ â†’ ãƒãƒƒãƒãƒ³ã‚° â†’ å“å1ã¤ â†’ æ¤œç´¢ â†’ å›ç­”

ã€v2.0ã€‘
å…¥åŠ› â†’ Hybrid Grounding System â†’ å“åå€™è£œ3ã¤ + å“è³ªè©•ä¾¡ â†’ æ¤œç´¢ â†’ å›ç­”
        â”œâ”€ ç²¾ç¢ºãƒãƒƒãƒ (æœ€é€Ÿ)
        â”œâ”€ Path A (é«˜é€Ÿ)
        â”œâ”€ Path B (é«˜ç²¾åº¦)
        â””â”€ Fallback (å®‰å…¨)
```

---

## ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ v2.0

### æ–°è¦è¿½åŠ 
- **Hybrid Grounding**: `rag/hybrid_grounding.py` (496è¡Œ)
- **å˜ä½“ãƒ†ã‚¹ãƒˆ**: `rag/test_hybrid.py` (13ãƒ†ã‚¹ãƒˆ, 100%é€šé)
- **ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«**: `rag/debug_hybrid.py`
- **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯**: `rag/benchmark_hybrid.py`

### ä¾å­˜é–¢ä¿‚
- Ollama LLM (swallow:latest) - Path Bã§ä½¿ç”¨
- ChromaDB (å¤‰æ›´ãªã—)
- Embedding (kun432/cl-nagoya-ruri-large:337m, å¤‰æ›´ãªã—)

### è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (HybridConfig)
```python
SHORT_INPUT_THRESHOLD = 20        # å¿«é€Ÿè·¯å¾„é–¾å€¤
CONFIDENCE_THRESHOLD_HIGH = 0.70  # é«˜ç½®ä¿¡åº¦é–¾å€¤
CONFIDENCE_THRESHOLD_LOW = 0.45   # ä½ç½®ä¿¡åº¦é–¾å€¤
AMBIGUITY_THRESHOLD = 0.05        # æ›–æ˜§æ€§åˆ¤å®šé–¾å€¤
LLM_MODEL = "swallow:latest"      # LLM ãƒ¢ãƒ‡ãƒ«
PATH_B_TIMEOUT = 5                # LLM ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

---

## ğŸ“Š å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ä¾‹

### ä¾‹1: çŸ­å…¥åŠ› (å¿«é€Ÿè·¯å¾„)
```
å…¥åŠ›: "ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³" (7æ–‡å­—)
  â†“
ç²¾ç¢ºãƒãƒƒãƒæ¤œæŸ»
  â”œâ”€ DBå†…ã« "ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³" å­˜åœ¨
  â””â”€ â†’ ç½®ä¿¡åº¦1.0 å³è¿”å´ (2.3ms) âœ…
  
çµæœ: 
  å“å: ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³
  ç½®ä¿¡åº¦: high (1.0)
  ä½¿ç”¨è·¯å¾„: path_a_exact
```

### ä¾‹2: é•·å…¥åŠ› (åŒè·¯å¾„)
```
å…¥åŠ›: "å¼•ã£è¶Šã—ã§ä½¿ã‚ãªããªã£ãŸãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ã¨å¤ã„ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã€å£Šã‚ŒãŸé›»å­ãƒ¬ãƒ³ã‚¸ã‚’å‡¦åˆ†ã—ãŸã„" (48æ–‡å­—)
  â†“
ç²¾ç¢ºãƒãƒƒãƒæ¤œæŸ»
  â””â”€ å®Œå…¨ä¸€è‡´ãªã— â†’ Pathé¸æŠ
  â†“
é•·å…¥åŠ› (â‰¥20æ–‡å­—) â†’ Path A + Path B
  â†“
Path A (æ•´ä½“Embedding):
  Top-3: [ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³, ãƒ—ãƒªãƒ³ã‚¿ãƒ¼, é›»å­ãƒ¬ãƒ³ã‚¸]
  
Path B (LLMæŠ½å‡º):
  LLM â†’ ["ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³", "ãƒ—ãƒªãƒ³ã‚¿ãƒ¼", "é›»å­ãƒ¬ãƒ³ã‚¸"]
    â†“ å„çŸ­èªã§æ¤œç´¢
  Top-3: [ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³, ãƒ—ãƒªãƒ³ã‚¿ãƒ¼, ãƒ‘ã‚½ã‚³ãƒ³ãƒ©ãƒƒã‚¯]
  
å€™è£œåˆå¹¶:
  ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³: åŒè·¯å¾„å‘½ä¸­ â†’ score boost (+0.1)
  æœ€çµ‚score: 1.03 â†’ 1.0 (è£å‰ª)
  â†“
çµæœ:
  å“å: ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ (ä¸»å€™è£œ)
  ç½®ä¿¡åº¦: high (1.0)
  ä½¿ç”¨è·¯å¾„: both
  å®Ÿè¡Œæ™‚é–“: 556ms
  æ›–æ˜§æ€§: ãªã— âœ…
```

### ä¾‹3: é™ç´šå‡¦ç†
```
å…¥åŠ›: "PCã‚’æ¨ã¦ãŸã„"
  â†“
ç²¾ç¢ºãƒãƒƒãƒæ¤œæŸ»
  â””â”€ ãªã—
  â†“
Path A: [ãƒ‘ã‚½ã‚³ãƒ³, ãƒ‘ã‚½ã‚³ãƒ³ãƒ©ãƒƒã‚¯, ...]
  â†“
Path B: LLMå‘¼ã³å‡ºã—
  â””â”€ âŒ Timeout (5ç§’è¶…é)
  â†“
âš ï¸ Fallbackç™ºå‹•
  â”œâ”€ MeCab: ["PC"] (åè©æŠ½å‡º)
  â”œâ”€ ç°¡æ˜“æ¤œç´¢: "PC" â†’ ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³
  â””â”€ âœ… é™ç´šæˆåŠŸ
  â†“
çµæœ:
  å“å: ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³
  ç½®ä¿¡åº¦: medium
  ä½¿ç”¨è·¯å¾„: degraded
```

---

## ğŸ¯ å“è³ªä¿è¨¼

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
```
test_hybrid.py - 13 tests, ALL PASSED âœ…

â€¢ è·¯å¾„Aãƒ†ã‚¹ãƒˆ      : 3/3 passed
â€¢ è·¯å¾„Bãƒ†ã‚¹ãƒˆ      : 2/2 passed
â€¢ åˆå¹¶ãƒ­ã‚¸ãƒƒã‚¯     : 2/2 passed
â€¢ å®Œå…¨ãƒ•ãƒ­ãƒ¼       : 3/3 passed
â€¢ æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ : 1/1 passed
â€¢ è¨­å®šæ¤œè¨¼         : 1/1 passed
â€¢ æ›–æ˜§æ€§æ¤œå‡º       : 1/1 passed
```

### ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹
```json
// referenceså†…ã®grounding_info
{
  "type": "grounding_info",
  "confidence": "high",
  "is_ambiguous": false,
  "candidates": ["ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³", "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ‘ã‚½ã‚³ãƒ³", "ãƒ‘ã‚½ã‚³ãƒ³ãƒ©ãƒƒã‚¯"],
  "execution_time_ms": 35.2
}

// performanceæƒ…å ±
{
  "type": "performance",
  "retrieval_time_ms": 127.4  // Hybrid + ChromaDBæ¤œç´¢
}
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **å®Ÿè£…è©³ç´°**: `rag/HYBRID_GROUNDING_V2_UPDATE.md`
- **é–‹ç™ºã‚¬ã‚¤ãƒ‰**: `DEVELOPMENT_cn.md` (v2.0æ›´æ–°æ¸ˆ)
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦**: `README.md` (v2.0æ›´æ–°æ¸ˆ)
- **APIä»•æ§˜**: `backend/API_REFERENCE.md`

---

**Last Update**: 2026-02-02  
**Version**: 2.0.0  
**Status**: Production Ready âœ…
