````markdown
# 垃圾分类 RAG 系统改进方案  
## Hybrid 品名指称（Grounding）与候选生成架构设计

---

## 1. 文档目的

本文档描述一种 **Hybrid（双路径）品名指称系统**，用于替换现有基于 MeCab 的名词抽取逻辑。  
该方案面向真实用户输入场景，解决以下长期存在的问题：

- 复合名词被错误拆分（例：ノートパソコン）
- 长文本导致候选名词爆炸
- 垃圾品名信号被上下文语义稀释
- 错误不可解释、不可控

本文档适用于：
- 系统架构设计说明
- 开发与实现参考
- 技术评审与维护文档

---

## 2. 设计背景与问题分析

### 2.1 现有系统的根本局限

现有系统基于如下假设：

> 用户输入 → 词法分析 → 名词集合 → 垃圾品名判断

但在现实中，该假设存在结构性问题：

1. **垃圾品名并不等价于名词**
2. **垃圾品名往往是复合实体**
3. **用户输入通常包含大量非目标语义**

因此，问题本质不是「分词精度不足」，而是：

> **系统缺乏对“用户指称对象”的语义定位能力**

---

## 3. Hybrid 方案设计目标

Hybrid 方案的设计目标如下：

1. 同时支持 **短指令型输入** 与 **长叙述型输入**
2. 在任何情况下保证 **至少一条稳定、可控的候选生成路径**
3. 避免单点失败（Single Point of Failure）
4. 明确区分：
   - 候选生成
   - 候选验证
   - 不确定性处理

---

## 4. 系统总体架构

### 4.1 核心思想

Hybrid 方案并非在两种方法中择一，而是：

> **将“整体语义定位”作为稳定基线，将“LLM 过滤”作为增强信号源**

---

### 4.2 系统流程总览

```text
                   ┌────────────────────┐
                   │   用户输入（原文）   │
                   └─────────┬──────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                   │
┌────────────────────┐             ┌────────────────────┐
│ 路径 A：整体 Embedding │             │ 路径 B：LLM 候选过滤 │
│ （稳定基线）         │             │ （语义聚焦增强）     │
└─────────┬──────────┘             └─────────┬──────────┘
          │                                   │
   Top-K_A（≤3）                    候选短语列表（≤5）
          │                                   │
          │                         对每个候选短语 Embedding
          │                                   │
          │                          Top-K_B（≤3）
          │                                   │
          └──────────────┬────────────────────┘
                         │
              候选合并 / 重排序 / 阈值判定
                         │
                最终垃圾品名候选
````

---

## 5. 路径 A：整体 Embedding 指称（Baseline）

### 5.1 设计目的

路径 A 提供：

* 完全确定性
* 稳定、可复现的行为
* 对所有输入类型的兜底能力

---

### 5.2 实现逻辑

1. 对 **用户输入全文** 直接进行 Embedding
2. 与垃圾品名向量库进行相似度计算
3. 选取 Top-K_A（推荐 K=3）

---

### 5.3 特点

* 不依赖分词或候选提取
* 对短输入极为有效
* 在长文本下可能出现语义稀释，但不会完全失败

---

## 6. 路径 B：LLM 候选过滤（增强路径）

### 6.1 设计目的

路径 B 的目标是：

> 在语义噪声较大的输入中，**显式提取“可能被用户指称为垃圾的实体表达”**

---

### 6.2 LLM 的角色约束

* LLM **不参与生成垃圾品名**
* 仅执行：

  * 指称短语抽取
  * 候选列举
* 输出必须：

  * 结构化
  * 可解析
  * 有上限数量

---

### 6.3 LLM 输入与输出规范

#### 输入

* 用户原始输入文本

#### 输出（示例）

```json
{
  "candidates": [
    "ノートパソコン",
    "周辺機器"
  ]
}
```

---

### 6.4 后处理流程

1. 对每个候选短语进行 Embedding
2. 分别与垃圾品名向量库匹配
3. 生成 Top-K_B（推荐 K=3）

---

## 7. 候选合并与决策机制

### 7.1 合并原则

* 合并 Top-K_A 与 Top-K_B 的结果集
* 对重复命中项进行权重提升

---

### 7.2 决策规则

#### 规则 1：稳定性优先

* 路径 A 始终存在
* 路径 B 仅增强，不替代

#### 规则 2：双路径一致性提升置信度

* 若某品名同时出现在 A 与 B 中 → 高置信候选

#### 规则 3：阈值判定

* 若最高相似度 < τ₁（如 0.35）
  → 判定为「无法确定垃圾品名」

#### 规则 4：歧义检测

* 若 Top-1 与 Top-2 差值 < τ₂（如 0.05）
  → 标记候选歧义，在 Prompt 中提示不确定性

---

## 8. 与 RAG 主系统的集成方式

Hybrid 方案 **仅替换品名候选生成模块**，其余模块保持不变：

* 垃圾分类规则检索
* 町名信息处理
* Prompt 强约束策略
* 回答生成与 Streaming 输出

---

## 9. 错误处理与降级策略

| 场景      | 行为              |
| ------- | --------------- |
| 路径 B 失败 | 忽略路径 B，仅使用路径 A  |
| 两路径均低置信 | 返回“无法确定品名”的明确提示 |
| 候选歧义    | 保留候选并在回答中显式提示   |

---

## 10. 方案优势总结

| 维度     | Hybrid 方案 |
| ------ | --------- |
| 鲁棒性    | 高（无单点失败）  |
| 复合名词支持 | 强         |
| 长文本适应性 | 强         |
| 行为可解释性 | 高         |
| 工程可维护性 | 高         |

---

## 11. 总结

Hybrid 品名指称方案通过 **“稳定基线 + 语义增强”** 的设计：

* 从根本上摆脱对分词质量的依赖
* 将垃圾品名识别问题转化为可控的语义指称问题
* 与现有 RAG 架构高度兼容

该方案适合作为垃圾分类 RAG 系统的下一代核心设计。

---
